##                                           分布式集中日志管理系统研究文档

- ### 背景介绍

#### 日志简介

在日常运维工作中，对于系统和业务日志的处理尤为重要。日志主要包括系统日志、应用程序日志、用户行为日志和安全日志。系统运维和开发人员可以通过日志了解服务器软硬件信息、检查配置过程中的错误及错误发生的原因。经常分析日志可以了解服务器的负荷，性能安全性，从而及时采取措施纠正错误。

#### 集中化日志引入的必要

通常日志被分散在储存不同的设备上。如果你管理数十上百台服务器，你还在使用依次登录每台机器的传统方法查阅日志。这样是不是感觉很繁琐和效率低下。当务之急我们应该使用集中化的日志管理系统。集中化日志管理方便分析服务健康度，信息查找，用户行为和热点数据，同时也符合行业大数据分析与行业未来的一些运筹。

- ### 技术简介

通过行业技术调研，开源的实时日志分析ELK+Kafka+FileBeat 能较好的支持日志集中管理系统，ELK+Kafka+FileBeat介绍如下：

1. ElasticSearch是一个基于Lucene的开源分布式搜索服务器。它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。[ElasticSearch官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/elasticsearch-intro.html)

2. Logstash是一个完全开源的工具，它可以对你的日志进行收集、过滤、分析，支持大量的数据获取方法。[Logstash官方文档](https://www.elastic.co/guide/en/logstash/master/introduction.html)

3. Kibana是一个开放源码的分析和可视化平台，设计用于Elasticsearch。使用Kibana搜索、查看和与存储在Elasticsearch索引中的数据交互。您可以轻松地执行高级数据分析，并在各种图表、表格和映射中可视化数据。[Kibana官方文档](https://www.elastic.co/guide/en/kibana/master/introduction.html)

4. Kafka是由Apache软件基金会开发的一个开源流处理平台，由Scala和Java编写。Kafka是一种高吞吐量的分布式发布订阅消息系统，它可以处理消费者在网站中的所有动作流数据。[Kafka官方文档](http://kafka.apache.org/documentation/)

5. FileBeat是一个轻量级的托运人，用于转发和集中日志数据。Filebeat作为代理安装在服务器上，监视您指定的日志文件或位置，收集日志事件，并将它们转发到Elasticsearch或Logstash进行索引。[FileBeat官方文档](https://www.elastic.co/guide/en/beats/filebeat/master/filebeat-overview.html)

   基于安全，日志抓取流程，客户端日志上报方案进行设计

- ### 架构演进

基于ELK的使用方式，Logstash 作为日志搜集器，ElasticSearch 进行日志存储，Kibana作为日志呈现，大致以下几种架构。

架构一：

![avatar](src\1567491766814.png)

图中 Logstash 多个的原因是考虑到程序是分布式架构的情况，每台机器都需要部署一个 Logstash，如果确实是单服务器的情况部署一个 Logstash 即可。

缺点：Logstash是jvm跑的，非常占用JAVA内存！8线程8GB内存下，Logstash常驻内存660M（JAVA）。因此，这么一个巨无霸部署在应用服务器端就不大合适了，我们需要一个更加轻量级的日志采集组件。上述架构如果部署成集群，所有业务放在一个大集群中相互影响。一个业务系统出问题了，就会拖垮整个日志系统。因此，需要进行业务隔离！

架构二：

![avatar](src\1567491942431.png)

相比于架构一，增加了一个kafka，Logstash 的输出和输入支持 Kafka、Redis、RabbitMQ 等常见消息队列，先将日志从服务加入队列，由 MQ 后面的 Logstash 继续解析和过滤，这样就不至于每台服务器消耗资源都很多。

缺点：日志写入对代码有一定的侵入性，LogStash有一定的单点问题。

架构三
综上两种架构LogStash的服务性能占用高，与单点问题引入FileBeat

![avatar](src\1567492050847.png)

首先，日志的收集用更高效的FileBeat，FileBeat所占的系统CPU和内存几乎可以忽略不计，对于日志解析和过滤的 Logstash 资源消耗还是比较高的，所以将 Logstash 的部署使用分布式，Elasticsearch 的部署使用集群来强化整个日志系统。[ELK架构下利用Kafka Group实现Logstash的高可用](https://www.cnblogs.com/37Y37/p/11130295.html)。

安全，日志收集流程，客户端手机流程来进行编写

- ### 日志采集分析

架构三很好的满足了集中式日志系统的架构方案，下面对该方案的流程进行详细介绍。

**服务端日志采集介绍**

采集日志方式直接从服务端已经生成的日志进行采集，服务端日志采集的作用以下几点：

- 信息查找   通过检索日志信息，定位相应的bug，找出解决方案
- 服务诊断   通过对日志信息进行统计、分析，了解服务器的负荷和服务运行状态，找出耗时请求进行优化等等。
- 数据分析   如果是格式化的log，可以做进一步的数据分析，统计、聚合出有意义的信息，比如根据请求中的商品id，找出TOP10用户感兴趣商品。

相关流程如下：

- 第一层：数据采集层
  Logs层：业务应用服务器集群，使用Filebeat对应用服务器的日志进行采集(采集方式可以是正则匹配，完全匹配)，并将采集到的日志数据传输到kafka中。
- 第二层：数据缓冲层
  kafka层：接收数据采集层的数据，转存到kafka+zookeeper集群中,做一个消息队列，让数据有一定的缓冲。
- 第三层：数据转发层
  LogStash层：这个集群的Logstash节点会实时去kafka Broker ConsumerGroup拉数据，通过日志数据的过滤与处理转发至ES DataNode。
- 第四层：数据持久化存储层
  ES层：会把收到的数据，写磁盘，建索引库。
- 第五层：数据检索、展示层
  Kibana层： 主要协调ES集群，处理数据检索请求，数据展示。当然也可以是我们自定义的日志监控系统。

**客户端日志采集介绍**

客户端日志采用接口上报形式，传递到服务端进行日志解析，持久化到持久层es，最终输出到展示端。客户端日志采集介绍如下

随着互联网的不断发展，用户所产生的行为数据被越来越多的网站重视，那么什么是用户行为呢？所谓的用户行为主要由五种元素组成：时间、地点、人物、行为、行为对应的内容。

用户行为主要有以下几个应用场景：

- 推荐系统：目前的推荐是基于用户的行为，然后运用不同的算法计算出用户应该展现的推荐数据。
- 系统bug定位：在某些用户的特定环境下，日志的上报可以直接定位当时用户的操作链，更精准快速的复现bug，快速解决。
- 转化率：一个用户从注册到各个页面的浏览等行为组成一个漏斗模型，漏斗的每个模型可以看到用户的留存状况。

为了降低频繁上报日志对应用性能的影响，客户端采集到数据后，会预先保存在应用本地，通过以下三种方式同步到日志服务器

- 自动上报：满足一定条件后自动上报

  ​     程序每次冷启动都会触发检查日志上报的逻辑。
  ​     程序进入后台会立即触发上报。
  ​     写日志时，某种类型的日志默认到达 40 条就触发上报。

- 实时监控：对于比较重要的客户端日志，如异常、应用闪退日志等，可实时上报，产生一条上报一条，便于后台实时监控。

- 动态控制：在自动上报的基础上，通过服务端下发的开关值，修改客户端日志写入和日志上报触发的条件。如在大流量并发的情况下，为减少日志服务器的压力，控制客户端只写入并上报异常或闪退日志，忽略行为日志的统计。